<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrological and Numerological Blueprint Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #1a202c; --card-background: #2d3748; --text-color: #e2e8f0;
            --heading-color: #ffffff; --accent-color: #805ad5; --accent-hover: #6b46c1;
            --border-color: #4a5568; --pre-background: #171923; --aspect-hard: #e53e3e;
            --aspect-soft: #3182ce; --aspect-neutral: #38a169;
        }
        body { font-family: 'Inter', sans-serif; line-height: 1.7; padding: 2rem; margin: 0; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; }
        h1, h2 { color: var(--heading-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.25rem; margin-bottom: 0.5rem; }
        h2 { margin-top: 3rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .description { background-color: var(--card-background); padding: 1.5rem 2rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid var(--border-color); }
        .description h3 { margin-top: 0; color: var(--heading-color); }
        .description a { color: var(--accent-color); text-decoration: none; }
        .description a:hover { text-decoration: underline; }
        form { background: var(--card-background); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); }
        label { font-weight: 500; display: block; margin-top: 1rem; margin-bottom: 0.5rem; }
        input[type="text"], input[type="number"], select { display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; background-color: var(--background-color); color: var(--text-color); font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.3); }
        button { width: 100%; padding: 0.85rem; font-size: 1.1rem; font-weight: 500; color: #fff; background-color: var(--accent-color); border: none; border-radius: 6px; cursor: pointer; margin-top: 2rem; transition: background-color 0.2s ease-in-out; }
        button:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        pre { background: var(--pre-background); padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; word-break: break-word; font-family: "Courier New", Courier, monospace; font-size: 14px; color: var(--text-color); }
        #gemini-output { font-family: 'Inter', sans-serif; font-size: 1rem; line-height: 1.7; }
        #chart-wheel-container { display: flex; justify-content: center; align-items: center; margin-top: 2rem; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; }
        #chart-wheel-svg { width: 100%; height: auto; aspect-ratio: 1 / 1; background-color: var(--pre-background); border-radius: 50%; }
        .wheel-circle { stroke: var(--border-color); stroke-width: 2; fill: none; }
        .zodiac-divider { stroke: var(--border-color); stroke-width: 1; }
        .house-cusp { stroke: var(--text-color); stroke-width: 2; }
        .house-cusp.major { stroke-width: 4; }
        .house-number { fill: var(--text-color); font-size: 28px; font-family: 'Inter', sans-serif; text-anchor: middle; dominant-baseline: middle; }
        .zodiac-glyph { fill: var(--text-color); font-size: 35px; text-anchor: middle; dominant-baseline: middle; }
        .planet-glyph { fill: var(--heading-color); font-size: 35px; text-anchor: middle; dominant-baseline: middle; }
        .planet-retrograde { fill: var(--text-color); font-size: 20px; }
        .aspect-line { stroke-width: 1.5; opacity: 0.7; }
        .aspect-conjunction { stroke: var(--aspect-neutral); }
        .aspect-opposition, .aspect-square { stroke: var(--aspect-hard); }
        .aspect-trine, .aspect-sextile { stroke: var(--aspect-soft); }
        .aspect-quincunx, .aspect-semisextile, .aspect-semisquare, .aspect-sesquiquadrate, .aspect-quintile, .aspect-biquintile { stroke: var(--border-color); stroke-dasharray: 4 4; }
        .time-toggle { display: flex; align-items: center; margin-top: 1.5rem; }
        .time-toggle input { width: auto; margin-right: 0.75rem; }
        .time-toggle label { margin: 0; }
        .time-note { font-size: 0.9rem; color: #a0aec0; margin-top: 1.5rem; }
        .analysis-note { text-align: center; margin: 1rem 0; font-size: 0.9rem; color: #a0aec0; }
        .privacy-section { margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; color: #a0aec0; }
        .privacy-section details { background-color: var(--card-background); border-radius: 8px; border: 1px solid var(--border-color); padding: 1rem 1.5rem; margin-bottom: 1rem; }
        .privacy-section summary { font-weight: 500; cursor: pointer; color: var(--text-color); }
        .privacy-section h4 { color: var(--heading-color); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .privacy-section p, .privacy-section ul { margin-bottom: 1rem; }
        .privacy-section a { color: var(--accent-color); }
        .time-inputs { display: flex; gap: 1rem; align-items: flex-end; }
        .time-inputs > div { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Astrological and Numerological Blueprint Calculator</h1>
        <div class="description">
            <h3>Your Complete Astrological Blueprint</h3>
            <p>This calculator provides a comprehensive analysis using the <strong>True Sidereal</strong> zodiac, which reflects the true, observable size of the constellations according to the official boundaries defined by the International Astronomical Union (IAU), including Ophiuchus.</p>
            <p>For a complete perspective, your report also includes a full chart calculated in the standard <strong>Tropical</strong> zodiac, allowing for direct comparison.</p>
            <p><strong>Your personalized report features:</strong></p>
            <ul>
                <li>An AI-powered astrological synthesis of your chart using Google's Gemini.</li>
                <li>A visual chart wheel showing your unique planetary alignment.</li>
                <li>Detailed Sidereal and Tropical placements for all planets and major points.</li>
                <li>In-depth analysis of aspects, patterns, and chart dominance.</li>
                <li>Your personal Numerology (Birth Date and Full Name) and Chinese Zodiac sign.</li>
            </ul>
            <p>For a full analysis of your chart, or for any questions, please contact: <a href="mailto:synthesisastrology@outlook.com">synthesisastrology@outlook.com</a></p>
            <p>Enter your birth details below to generate your complete astrological profile.</p>
        </div>

        <form id="chartForm">
            <label for="fullName">Full Birth Name (including middle name for numerology)</label>
            <input type="text" id="fullName" name="fullName" required value="">
            
            <label for="birthDate">Birth Date (MM/DD/YYYY)</label>
            <input type="text" id="birthDate" name="birthDate" required value="" placeholder="e.g., 05/15/1992">

            <p class="time-note">For the most accurate results, please use your exact time of birth. If you do not know it, you can select the checkbox below to exclude time-sensitive information from the output.</p>
            <div class="time-toggle">
                <input type="checkbox" id="unknownTime" name="unknownTime">
                <label for="unknownTime">I don't know my birth time</label>
            </div>

            <div class="time-inputs">
                <div> <label for="hour">Hour</label> <input type="number" id="hour" name="hour" required value="" min="1" max="12"> </div>
                <div> <label for="minute">Minute</label> <input type="number" id="minute" name="minute" required value="" min="0" max="59"> </div>
                <div> <label for="ampm">AM/PM</label> <select id="ampm" name="ampm"><option value="am">AM</option><option value="pm">PM</option></select> </div>
            </div>
            
            <label for="location">Birth Location</label><input type="text" id="location" name="location" required value="">
            <button type="submit" id="submitBtn">Calculate Chart</button>
        </form>

        <h2 id="gemini-title" style="display: none;">AI Astrological Synthesis</h2>
        <pre id="gemini-output" style="display: none;"></pre>

        <h2 id="results-title" style="display: none;">Results</h2>
        <pre id="output" style="display: none;"></pre>

        <h2 id="wheel-title" style="display: none;">Chart Wheel</h2>
        <div id="chart-wheel-container" style="display: none;"> <svg id="chart-wheel-svg" viewBox="0 0 1000 1000"></svg> </div>

        <h2 id="legend-title" style="display: none;">Glyph Legend</h2>
        <pre id="glyph-legend" style="display: none;"></pre>

        <div class="privacy-section">
             </div>
    </div>

    <script>
    const AstrologyCalculator = {
        // --- CONFIGURATION & CONSTANTS ---
        API_URL: "https://true-sidereal-api.onrender.com/calculate_chart",
        SVG_NS: "http://www.w3.org/2000/svg",
        ZODIAC_GLYPHS: {'Aries':'♈︎','Taurus':'♉︎','Gemini':'♊︎','Cancer':'♋︎','Leo':'♌︎','Virgo':'♍︎','Libra':'♎︎','Scorpio':'♏︎','Ophiuchus':'⛎︎','Sagittarius':'♐︎','Capricorn':'♑︎','Aquarius':'♒︎','Pisces':'♓︎'},
        PLANET_GLYPHS: {'Sun':'☉','Moon':'☽','Mercury':'☿','Venus':'♀','Mars':'♂','Jupiter':'♃','Saturn':'♄','Uranus':'♅','Neptune':'♆','Pluto':'♇','Chiron':'⚷','True Node':'☊','South Node':'☋','Ascendant':'AC','Midheaven (MC)':'MC','Descendant':'DC','Imum Coeli (IC)':'IC'},

        // --- DOM ELEMENTS ---
        form: null,
        submitBtn: null,
        outputEl: null,
        geminiTitle: null,
        geminiOutput: null,
        resultsTitle: null,
        wheelTitle: null,
        wheelContainer: null,
        wheelSvg: null,
        legendTitle: null,
        legendEl: null,
        
        // --- INITIALIZATION ---
        init() {
            this.cacheDOMElements();
            this.addEventListeners();
            this.populateGlyphLegend();
        },

        cacheDOMElements() {
            this.form = document.getElementById("chartForm");
            this.submitBtn = document.getElementById("submitBtn");
            this.outputEl = document.getElementById("output");
            this.geminiTitle = document.getElementById('gemini-title');
            this.geminiOutput = document.getElementById('gemini-output');
            this.resultsTitle = document.getElementById('results-title');
            this.wheelTitle = document.getElementById('wheel-title');
            this.wheelContainer = document.getElementById('chart-wheel-container');
            this.wheelSvg = document.getElementById('chart-wheel-svg');
            this.legendTitle = document.getElementById('legend-title');
            this.legendEl = document.getElementById('glyph-legend');
        },
        
        addEventListeners() {
            // "I don't know my time" checkbox logic
            const unknownTimeCheckbox = document.getElementById('unknownTime');
            const hourInput = document.getElementById('hour');
            const minuteInput = document.getElementById('minute');
            const ampmSelect = document.getElementById('ampm');
            
            unknownTimeCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                hourInput.disabled = isChecked;
                minuteInput.disabled = isChecked;
                ampmSelect.disabled = isChecked;
                if (isChecked) {
                    hourInput.value = '12';
                    minuteInput.value = '00';
                    ampmSelect.value = 'pm'; // Noon
                }
            });

            // Form submission
            this.form.addEventListener("submit", (e) => this.handleFormSubmit(e));
        },

        // --- CORE LOGIC ---
        async handleFormSubmit(e) {
            e.preventDefault();
            this.setLoadingState(true);

            try {
                const birthDateParts = this.form.querySelector("[name='birthDate']").value.split('/');
                if (birthDateParts.length !== 3) throw new Error("Please enter the date in MM/DD/YYYY format.");
                const [month, day, year] = birthDateParts.map(s => parseInt(s));

                let hour = parseInt(this.form.querySelector("[name='hour']").value);
                const ampm = this.form.querySelector("[name='ampm']").value;

                if (ampm === 'pm' && hour < 12) hour += 12;
                if (ampm === 'am' && hour === 12) hour = 0; // Midnight hour

                const apiRes = await fetch(this.API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        full_name: this.form.querySelector("[name='fullName']").value,
                        year: year, month: month, day: day, hour: hour,
                        minute: parseInt(this.form.querySelector("[name='minute']").value),
                        location: this.form.querySelector("[name='location']").value,
                        unknown_time: this.form.querySelector("[name='unknownTime']").checked
                    }),
                });

                if (!apiRes.ok) {
                    const errData = await apiRes.json();
                    throw new Error(`API Error ${apiRes.status}: ${errData.detail}`);
                }
                const result = await apiRes.json();
                
                this.displayResults(result);

            } catch (err) {
                this.outputEl.innerText = "Error: " + err.message;
                this.resultsTitle.style.display = 'block';
                this.outputEl.style.display = 'block';
            } finally {
                this.setLoadingState(false);
            }
        },

        setLoadingState(isLoading) {
            this.submitBtn.disabled = isLoading;
            this.submitBtn.innerText = isLoading ? "Calculating..." : "Calculate Chart";

            // Hide all result sections when starting a new calculation
            this.geminiTitle.style.display = 'none';
            this.geminiOutput.style.display = 'none';
            this.resultsTitle.style.display = 'none';
            this.outputEl.style.display = 'none';
            this.wheelTitle.style.display = 'none';
            this.wheelContainer.style.display = 'none';
            this.legendTitle.style.display = 'none';
            this.legendEl.style.display = 'none';
            this.wheelSvg.innerHTML = '';
            
            if (isLoading) {
                this.resultsTitle.style.display = 'block';
                this.outputEl.style.display = 'block';
                this.outputEl.innerText = "Calculating chart, this may take a moment...";
            }
        },

        displayResults(res) {
            // Show Gemini AI Reading if available
            if (res.gemini_reading) {
                this.geminiTitle.style.display = 'block';
                this.geminiOutput.style.display = 'block';
                this.geminiOutput.innerText = res.gemini_reading;
            }

            // Show text results
            this.resultsTitle.style.display = 'block';
            this.outputEl.style.display = 'block';
            this.renderTextResults(res);

            // Show Chart Wheel and Legend if time is known
            if (!res.unknown_time) {
                this.wheelTitle.style.display = 'block';
                this.wheelContainer.style.display = 'flex';
                this.legendTitle.style.display = 'block';
                this.legendEl.style.display = 'block';
                this.drawChartWheel(res);
            }
        },

        renderTextResults(res) {
            let out = `=== TRUE SIDEREAL CHART: ${res.name} ===\n`;
            out += `- UTC Date & Time: ${res.utc_datetime}${res.unknown_time ? ' (Noon Estimate)' : ''}\n`;
            out += `- Location: ${res.location}\n`;
            out += `- Day/Night Determination: ${res.day_night_status}\n\n`;
            
            out += `--- CHINESE ZODIAC ---\n`;
            out += `- Your sign is the ${res.chinese_zodiac}\n\n`;

            out += `--- NUMEROLOGY REPORT ---\n`;
            if (res.numerology_analysis) {
                out += `- Life Path Number: ${res.numerology_analysis.life_path_number}\n`;
                out += `- Day Number: ${res.numerology_analysis.day_number}\n`;
                if (res.numerology_analysis.name_numerology) {
                    out += `\n-- NAME NUMEROLOGY --\n`;
                    out += `- Expression (Destiny) Number: ${res.numerology_analysis.name_numerology.expression_number}\n`;
                    out += `- Soul Urge Number: ${res.numerology_analysis.name_numerology.soul_urge_number}\n`;
                    out += `- Personality Number: ${res.numerology_analysis.name_numerology.personality_number}\n`;
                }
            }
            
            out += `\n-- SIDEREAL CHART ANALYSIS --\n`;
            out += `- Chart Ruler: ${res.sidereal_chart_analysis.chart_ruler}\n`;
            out += `- Dominant Sign: ${res.sidereal_chart_analysis.dominant_sign}\n`;
            out += `- Dominant Element: ${res.sidereal_chart_analysis.dominant_element}\n`;
            out += `- Dominant Modality: ${res.sidereal_chart_analysis.dominant_modality}\n`;
            out += `- Dominant Planet: ${res.sidereal_chart_analysis.dominant_planet}\n\n`;
            
            out += `--- MAJOR POSITIONS ---\n`;
            res.sidereal_major_positions.forEach(p => {
                let line = `- ${p.name}: ${p.position}`;
                if (!['Ascendant', 'Descendant', 'Midheaven (MC)', 'Imum Coeli (IC)', 'South Node'].includes(p.name)) {
                    line += ` (${p.percentage}%)`;
                }
                if (p.retrograde) { line += " (Rx)"; }
                if (p.house_info) { line += ` ${p.house_info}`; }
                out += `${line}\n`;
            });
            out += `\n--- MAJOR ASPECTS (ranked by influence score) ---\n`;
            res.sidereal_aspects.forEach(a => { out += `- ${a.p1_name} ${a.type} ${a.p2_name} (orb ${a.orb}, score ${a.score})\n`; });
            out += `\n--- ASPECT PATTERNS ---\n`;
            (res.sidereal_aspect_patterns && res.sidereal_aspect_patterns.length > 0) ? res.sidereal_aspect_patterns.forEach(p => { out += `- ${p}\n`; }) : out += "- No major aspect patterns detected.\n";
            if (!res.unknown_time) {
                out += `\n--- ADDITIONAL POINTS & ANGLES ---\n`;
                res.sidereal_additional_points.forEach(p => { 
                    let line = `- ${p.name}: ${p.info}`;
                    if (p.retrograde) { line += " (Rx)"; }
                    out += `${line}\n`; 
                });
                out += `\n--- HOUSE RULERS ---\n`;
                for (const [house, info] of Object.entries(res.house_rulers)) { out += `- ${house}: ${info}\n`; }
                out += `\n--- HOUSE SIGN DISTRIBUTIONS ---\n`;
                for (const [house, segments] of Object.entries(res.house_sign_distributions)) {
                    out += `${house}:\n`;
                    if (segments && segments.length > 0) {
                        segments.forEach(seg => { out += `      - ${seg}\n`; });
                    }
                }
            } else {
                out += `\n- (House Rulers, House Distributions, and some additional points require a known birth time and are not displayed.)\n`;
            }

            if (res.tropical_major_positions && res.tropical_major_positions.length > 0) {
                out += `\n\n\n=== TROPICAL CHART ===\n\n`;
                out += `-- CHART ANALYSIS --\n`;
                out += `- Dominant Sign: ${res.tropical_chart_analysis.dominant_sign}\n`;
                out += `- Dominant Element: ${res.tropical_chart_analysis.dominant_element}\n`;
                out += `- Dominant Modality: ${res.tropical_chart_analysis.dominant_modality}\n`;
                out += `- Dominant Planet: ${res.tropical_chart_analysis.dominant_planet}\n\n`;
                out += `--- MAJOR POSITIONS ---\n`;
                res.tropical_major_positions.forEach(p => {
                    let line = `- ${p.name}: ${p.position}`;
                    if (!['Ascendant', 'Descendant', 'Midheaven (MC)', 'Imum Coeli (IC)', 'South Node'].includes(p.name)) {
                        line += ` (${p.percentage}%)`;
                    }
                    if (p.retrograde) { line += " (Rx)"; }
                    if (p.house_info) { line += ` ${p.house_info}`; }
                    out += `${line}\n`;
                });
                out += `\n--- MAJOR ASPECTS (ranked by influence score) ---\n`;
                res.tropical_aspects.forEach(a => { out += `- ${a.p1_name} ${a.type} ${a.p2_name} (orb ${a.orb}, score ${a.score})\n`; });
                out += `\n--- ASPECT PATTERNS ---\n`;
                (res.tropical_aspect_patterns && res.tropical_aspect_patterns.length > 0) ? res.tropical_aspect_patterns.forEach(p => { out += `- ${p}\n`; }) : out += "- No major aspect patterns detected.\n";
                if (!res.unknown_time) {
                    out += `\n--- ADDITIONAL POINTS & ANGLES ---\n`;
                    res.tropical_additional_points.forEach(p => { 
                        let line = `- ${p.name}: ${p.info}`;
                        if (p.retrograde) { line += " (Rx)"; }
                        out += `${line}\n`; 
                    });
                }
            }
            this.outputEl.innerText = out;
        },
        
        // --- SVG DRAWING ---
        drawChartWheel(data) {
            const svg = this.wheelSvg;
            svg.innerHTML = ''; 

            const centerX = 500, centerY = 500;
            const zodiacRadius = 450, houseRingRadius = 350, planetGlyphRadius = 320, innerRadius = 150;
            
            const ascendant = data.sidereal_major_positions.find(p => p.name === 'Ascendant');
            if (!ascendant || ascendant.degrees === null) {
                svg.innerHTML = '<text x="500" y="500" class="house-number">Chart wheel requires a known birth time.</text>';
                return;
            }
            
            const rotation = -ascendant.degrees;
            const mainGroup = document.createElementNS(this.SVG_NS, 'g');
            mainGroup.setAttribute('transform', `rotate(${rotation} ${centerX} ${centerY})`);
            svg.appendChild(mainGroup);

            const degreeToCartesian = (radius, angleDegrees) => {
                const angleRadians = angleDegrees * (Math.PI / 180);
                return { x: centerX + radius * Math.cos(angleRadians), y: centerY - radius * Math.sin(angleRadians) };
            };

            // Draw Aspects
            if (data.sidereal_aspects) {
                data.sidereal_aspects.forEach(aspect => {
                    if (aspect.p1_degrees === null || aspect.p2_degrees === null) return;
                    const p1Coords = degreeToCartesian(innerRadius, aspect.p1_degrees);
                    const p2Coords = degreeToCartesian(innerRadius, aspect.p2_degrees);
                    const line = document.createElementNS(this.SVG_NS, 'line');
                    line.setAttribute('x1', p1Coords.x); line.setAttribute('y1', p1Coords.y);
                    line.setAttribute('x2', p2Coords.x); line.setAttribute('y2', p2Coords.y);
                    const aspectClass = aspect.type.toLowerCase().replace(' ', '-');
                    line.setAttribute('class', `aspect-line aspect-${aspectClass}`);
                    mainGroup.appendChild(line);
                });
            }

            // Draw Circles
            [zodiacRadius, houseRingRadius, innerRadius].forEach(r => {
                const circle = document.createElementNS(this.SVG_NS, 'circle');
                circle.setAttribute('cx', centerX); circle.setAttribute('cy', centerY);
                circle.setAttribute('r', r); circle.setAttribute('class', 'wheel-circle');
                svg.appendChild(circle);
            });
            
            // Draw Zodiac Signs & Dividers
            if (data.true_sidereal_signs) {
                const glyphRadius = houseRingRadius + (zodiacRadius - houseRingRadius) / 2;
                data.true_sidereal_signs.forEach(sign => {
                    const [name, start, end] = sign;
                    const p1 = degreeToCartesian(houseRingRadius, start);
                    const p2 = degreeToCartesian(zodiacRadius, start);
                    const line = document.createElementNS(this.SVG_NS, 'line');
                    line.setAttribute('x1', p1.x); line.setAttribute('y1', p1.y);
                    line.setAttribute('x2', p2.x); line.setAttribute('y2', p2.y);
                    line.setAttribute('class', 'zodiac-divider');
                    mainGroup.appendChild(line);

                    const midAngle = start + ((end - start + 360) % 360) / 2;
                    const textCoords = degreeToCartesian(glyphRadius, midAngle);
                    const text = document.createElementNS(this.SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'zodiac-glyph');
                    text.setAttribute('transform', `rotate(${-rotation} ${textCoords.x} ${textCoords.y})`);
                    text.textContent = this.ZODIAC_GLYPHS[name];
                    mainGroup.appendChild(text);
                });
            }

            // Draw House Cusps & Numbers
            if (data.house_cusps && data.house_cusps.length === 12) {
                data.house_cusps.forEach((cuspDegrees, i) => {
                    const p1 = degreeToCartesian(innerRadius, cuspDegrees);
                    const p2 = degreeToCartesian(houseRingRadius, cuspDegrees);
                    const line = document.createElementNS(this.SVG_NS, 'line');
                    line.setAttribute('x1', p1.x); line.setAttribute('y1', p1.y);
                    line.setAttribute('x2', p2.x); line.setAttribute('y2', p2.y);
                    line.setAttribute('class', (i % 3 === 0) ? 'house-cusp major' : 'house-cusp');
                    mainGroup.appendChild(line);
                });
                for (let i = 0; i < 12; i++) {
                    const startAngle = data.house_cusps[i];
                    const endAngle = data.house_cusps[(i + 1) % 12];
                    let midAngle = (startAngle + endAngle) / 2;
                    if (endAngle < startAngle) midAngle = ((startAngle + endAngle + 360) / 2) % 360;
                    const textCoords = degreeToCartesian(innerRadius + 25, midAngle);
                    const text = document.createElementNS(this.SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'house-number');
                    text.setAttribute('transform', `rotate(${-rotation} ${textCoords.x} ${textCoords.y})`);
                    text.textContent = i + 1;
                    mainGroup.appendChild(text);
                }
            }
            
            // Draw Planets
            if (data.sidereal_major_positions) {
                data.sidereal_major_positions.forEach(planet => {
                    if (planet.degrees === null || !this.PLANET_GLYPHS[planet.name]) return;
                    const textCoords = degreeToCartesian(planetGlyphRadius, planet.degrees);
                    const text = document.createElementNS(this.SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'planet-glyph');
                    text.setAttribute('transform', `rotate(${-rotation} ${textCoords.x} ${textCoords.y})`);
                    text.textContent = this.PLANET_GLYPHS[planet.name];
                    mainGroup.appendChild(text);
                    if (planet.retrograde) {
                        const rxCoords = degreeToCartesian(planetGlyphRadius + 2, planet.degrees - 4.5);
                        const rxText = document.createElementNS(this.SVG_NS, 'text');
                        rxText.setAttribute('x', rxCoords.x); rxText.setAttribute('y', rxCoords.y);
                        rxText.setAttribute('class', 'planet-retrograde');
                        rxText.setAttribute('transform', `rotate(${-rotation} ${rxCoords.x} ${rxCoords.y})`);
                        rxText.textContent = '℞';
                        mainGroup.appendChild(rxText);
                    }
                });
            }
        },
        
        populateGlyphLegend() {
            let legendText = '--- ZODIAC SIGNS ---\n';
            for (const [name, glyph] of Object.entries(this.ZODIAC_GLYPHS)) {
                legendText += `${glyph} - ${name}\n`;
            }
            legendText += '\n--- PLANETS & POINTS ---\n';
            for (const [name, glyph] of Object.entries(this.PLANET_GLYPHS)) {
                legendText += `${glyph} - ${name}\n`;
            }
            this.legendEl.innerText = legendText;
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        AstrologyCalculator.init();
    });
    </script>
</body>
</html>
