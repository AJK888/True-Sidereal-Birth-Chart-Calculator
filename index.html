<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>True Sidereal Chart Calculator</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 2rem; max-width: 800px; margin: auto; background-color: #f8f9fa; }
    h1 { color: #333; }
    form { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    label { font-weight: bold; display: block; margin-top: 1rem; color: #555; }
    input { display: block; width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { width: 100%; padding: 0.75rem; font-size: 1rem; color: #fff; background-color: #007bff; border: none; border-radius: 4px; cursor: pointer; }
    pre { background: #fff; padding: 1.5rem; border: 1px solid #eee; border-radius: 4px; white-space: pre-wrap; word-break: break-word; font-family: "Courier New", Courier, monospace; font-size: 14px; }
  </style>
</head>
<body>
  <h1>True Sidereal Chart</h1>
  <form id="chartForm">
    <label for="name">Name</label><input type="text" id="name" name="name" required value="">
    <label for="year">Birth Year</label><input type="number" id="year" name="year" required value="">
    <label for="month">Birth Month</label><input type="number" id="month" name="month" required value="">
    <label for="day">Birth Day</label><input type="number" id="day" name="day" required value="">
    <label for="hour">Birth Hour (e.g., 17 for 5 PM)</label><input type="number" id="hour" name="hour" required value="">
    <label for="minute">Birth Minute</label><input type="number" id="minute" name="minute" required value="">
    <label for="location">Birth Location</label><input type="text" id="location" name="location" required value="">
    <button type="submit" id="submitBtn">Calculate Chart</button>
  </form>
  <h2>Results</h2>
  <pre id="output">Enter birth details and click "Calculate Chart".</pre>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script>
    document.getElementById("chartForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target, outputEl = document.getElementById("output"), btn = document.getElementById("submitBtn");
      btn.disabled = true; btn.innerText = "Calculating...";
      outputEl.innerText = "Geocoding location and calculating chart...";

      try {
        const locationInput = form.querySelector("[name='location']").value;
        const geoUrl = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(locationInput)}&key=122d238a65bc443297d6144ba105975d`;
        const geoRes = await fetch(AJK888.pythonanywhere.com);
        const geoData = await geoRes.json();
        if (!geoData.results || geoData.results.length === 0) throw new Error("Location not found.");
        const { lat, lng } = geoData.results[0].geometry;
        const timezone = geoData.results[0].annotations.timezone.name;

        const localTime = luxon.DateTime.fromObject({
          year: parseInt(form.querySelector("[name='year']").value), month: parseInt(form.querySelector("[name='month']").value),
          day: parseInt(form.querySelector("[name='day']").value), hour: parseInt(form.querySelector("[name='hour']").value),
          minute: parseInt(form.querySelector("[name='minute']").value)
        }, { zone: timezone });
        if (!localTime.isValid) throw new Error(`Invalid Date/Time: ${localTime.invalidReason}`);
        const utcTime = localTime.toUTC();

        const apiRes = await fetch("http://127.0.0.1:8000/calculate_chart", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: form.querySelector("[name='name']").value, year: utcTime.year, month: utcTime.month,
            day: utcTime.day, hour: utcTime.hour, minute: utcTime.minute, latitude: lat, longitude: lng
          }),
        });
        if (!apiRes.ok) { const errTxt = await apiRes.text(); throw new Error(`API Error ${apiRes.status}: ${errTxt}`); }
        const result = await apiRes.json();
        renderResults(result);
      } catch (err) { outputEl.innerText = "Error: " + err.message;
      } finally { btn.disabled = false; btn.innerText = "Calculate Chart"; }
    });

    function renderResults(res) {
      console.log(res); // <-- ADD THIS LINE

    let out = `=== TRUE SIDEREAL CHART: ${res.name} ===\n`;
      out += `UTC Date & Time: ${res.utc_datetime}\n`;
      out += `Location: ${res.location}\n`;
      out += `Day/Night Determination: ${res.day_night_status}\n\n`;

      out += `-- CHART ANALYSIS --\n`;
      out += `Chart Ruler: ${res.chart_analysis.chart_ruler}\n`;
      out += `Dominant Sign: ${res.chart_analysis.dominant_sign}\n`;
      out += `Dominant Element: ${res.chart_analysis.dominant_element}\n`;
      out += `Dominant Modality: ${res.chart_analysis.dominant_modality}\n`;
      out += `Dominant Planet: ${res.chart_analysis.dominant_planet}\n`;
      out += `Life Path Number: ${res.chart_analysis.life_path_number}\n`;
      out += `Day Number: ${res.chart_analysis.day_number}\n`;
      out += `Chinese Zodiac: ${res.chart_analysis.chinese_zodiac}\n\n`;
      
      out += `--- MAJOR POSITIONS ---\n`;
      res.major_positions.forEach(p => {
        let line = `${p.name}: ${p.position}`;
        if (!['Ascendant', 'Descendant', 'Midheaven (MC)', 'Imum Coeli (IC)', 'South Node'].includes(p.name)) {
            line += ` (${p.percentage}%)`;
        }
        if (p.retrograde) { line += " (Rx)"; }
        if (p.house_info) { line += ` ${p.house_info}`; }
        out += `${line}\n`;
      });

      out += `\n--- MAJOR ASPECTS (ranked by influence score) ---\n`;
      res.aspects.forEach(a => { out += `${a.p1_name} ${a.type} ${a.p2_name} (orb ${a.orb}, score ${a.score})\n`; });
      
      out += `\n--- ASPECT PATTERNS ---\n`;
      (res.aspect_patterns && res.aspect_patterns.length > 0) ? res.aspect_patterns.forEach(p => { out += `- ${p}\n`; }) : out += "No major aspect patterns detected.\n";

      out += `\n--- ADDITIONAL POINTS & ANGLES ---\n`;
      res.additional_points.forEach(p => { out += `${p.name}: ${p.info}\n`; });
      
      out += `\n--- HOUSE RULERS ---\n`;
      for (const [house, info] of Object.entries(res.house_rulers)) { out += `${house}: ${info}\n`; }
      
      out += `\n--- HOUSE SIGN DISTRIBUTIONS ---\n`;
      for (const [house, segments] of Object.entries(res.house_sign_distributions)) {
        out += `- ${house}\n`;
        if (segments && segments.length > 0) {
            segments.forEach(seg => { out += `     - ${seg}\n`; });
        }
      }
      document.getElementById("output").innerText = out;
    }
  </script>
</body>
</html>
