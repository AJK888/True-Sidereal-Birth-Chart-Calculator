<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Sidereal Chart Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #1a202c;
            --card-background: #2d3748;
            --text-color: #e2e8f0;
            --heading-color: #ffffff;
            --accent-color: #805ad5;
            --accent-hover: #6b46c1;
            --border-color: #4a5568;
            --pre-background: #171923;
            --aspect-hard: #e53e3e;
            --aspect-soft: #3182ce;
            --aspect-neutral: #38a169;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7; padding: 2rem; margin: 0; background-color: var(--background-color);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
        }

        .container { max-width: 800px; width: 100%; }
        h1, h2 { color: var(--heading-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.25rem; margin-bottom: 0.5rem; }
        h2 { margin-top: 3rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }

        .description { background-color: var(--card-background); padding: 1.5rem 2rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid var(--border-color); }
        .description h3 { margin-top: 0; color: var(--heading-color); }

        form { background: var(--card-background); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); }
        label { font-weight: 500; display: block; margin-top: 1rem; margin-bottom: 0.5rem; }
        input { display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; background-color: var(--background-color); color: var(--text-color); font-size: 1rem; }
        input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.3); }
        button { width: 100%; padding: 0.85rem; font-size: 1.1rem; font-weight: 500; color: #fff; background-color: var(--accent-color); border: none; border-radius: 6px; cursor: pointer; margin-top: 2rem; transition: background-color 0.2s ease-in-out; }
        button:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        pre { background: var(--pre-background); padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; word-break: break-word; font-family: "Courier New", Courier, monospace; font-size: 14px; color: var(--text-color); }
        
        #chart-wheel-container { display: flex; justify-content: center; align-items: center; margin-top: 2rem; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; }
        #chart-wheel-svg { width: 100%; height: auto; aspect-ratio: 1 / 1; background-color: var(--pre-background); border-radius: 50%; }

        .wheel-circle { stroke: var(--border-color); stroke-width: 2; fill: none; }
        .zodiac-divider { stroke: var(--border-color); stroke-width: 1; }
        .house-cusp { stroke: var(--text-color); stroke-width: 2; }
        .house-cusp.major { stroke-width: 4; }
        .house-number { fill: var(--text-color); font-size: 28px; font-family: 'Inter', sans-serif; text-anchor: middle; dominant-baseline: middle; }
        .zodiac-glyph { fill: var(--text-color); font-size: 35px; text-anchor: middle; dominant-baseline: middle; }
        .planet-glyph { fill: var(--heading-color); font-size: 35px; text-anchor: middle; dominant-baseline: middle; }
        .planet-retrograde { fill: var(--text-color); font-size: 20px; }
        .aspect-line { stroke-width: 1.5; opacity: 0.7; }
        .aspect-conjunction { stroke: var(--aspect-neutral); }
        .aspect-opposition, .aspect-square { stroke: var(--aspect-hard); }
        .aspect-trine, .aspect-sextile { stroke: var(--aspect-soft); }
        .aspect-quincunx, .aspect-semisextile, .aspect-semisquare, .aspect-sesquiquadrate, .aspect-quintile, .aspect-biquintile { stroke: var(--border-color); stroke-dasharray: 4 4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>True Sidereal Chart</h1>
        <div class="description">
            <h3>Discover Your True Cosmic Blueprint</h3>
            <p>Welcome to the True Sidereal Birth Chart Calculator...</p>
        </div>

        <form id="chartForm">
            <!-- Form inputs remain the same -->
        </form>

        <h2>Chart Wheel</h2>
        <div id="chart-wheel-container">
            <svg id="chart-wheel-svg" viewBox="0 0 1000 1000"></svg>
        </div>

        <h2>Results</h2>
        <pre id="output">Your personalized report will appear here.</pre>
    </div>

    <script>
        // The main event listener remains the same
        document.getElementById("chartForm").addEventListener("submit", async function (e) { /* ... */ });
        // The renderResults function remains the same
        function renderResults(res) { /* ... */ }

        const SVG_NS = "http://www.w3.org/2000/svg";
        const ZODIAC_GLYPHS = {'Aries':'♈','Taurus':'♉','Gemini':'♊','Cancer':'♋','Leo':'♌','Virgo':'♍','Libra':'♎','Scorpio':'♏','Ophiuchus':'⛎','Sagittarius':'♐','Capricorn':'♑','Aquarius':'♒','Pisces':'♓'};
        const PLANET_GLYPHS = {'Sun':'☉','Moon':'☽','Mercury':'☿','Venus':'♀','Mars':'♂','Jupiter':'♃','Saturn':'♄','Uranus':'♅','Neptune':'♆','Pluto':'♇','Chiron':'⚷','True Node':'☊','South Node':'☋','Ascendant':'AC','Midheaven (MC)':'MC','Descendant':'DC','Imum Coeli (IC)':'IC'};

        function drawChartWheel(data) {
            const svg = document.getElementById('chart-wheel-svg');
            svg.innerHTML = ''; 

            const centerX = 500;
            const centerY = 500;
            const zodiacRadius = 450;
            const houseRingRadius = 350;
            const planetRingRadius = 250;
            const innerRadius = 150;

            // --- REFACTORED: Rotation Logic ---
            const ascendant = data.major_positions.find(p => p.name === 'Ascendant');
            if (!ascendant) return; // Can't draw without ascendant
            
            // Calculate rotation so Ascendant is at 180 degrees (left horizon)
            const rotationAngle = 180 - ascendant.degrees;

            function getCoords(radius, angleDegrees) {
                // Apply the rotation to the angle before converting to coordinates
                const rotatedAngle = (angleDegrees + rotationAngle + 360) % 360;
                const angleRadians = (rotatedAngle - 90) * (Math.PI / 180);
                return { x: centerX + radius * Math.cos(angleRadians), y: centerY + radius * Math.sin(angleRadians) };
            }

            // Draw concentric circles (these don't rotate)
            [zodiacRadius, houseRingRadius, innerRadius].forEach(r => {
                const circle = document.createElementNS(SVG_NS, 'circle');
                circle.setAttribute('cx', centerX);
                circle.setAttribute('cy', centerY);
                circle.setAttribute('r', r);
                circle.setAttribute('class', 'wheel-circle');
                svg.appendChild(circle);
            });
            
            // --- REFACTORED: Draw Unequal Zodiac Dividers and Glyphs ---
            if (data.true_sidereal_signs) {
                const glyphRadius = houseRingRadius + (zodiacRadius - houseRingRadius) / 2;
                data.true_sidereal_signs.forEach(sign => {
                    const [name, start, end] = sign;
                    
                    // Draw divider line at the start of the sign
                    const startPoint = getCoords(houseRingRadius, start);
                    const endPoint = getCoords(zodiacRadius, start);
                    const line = document.createElementNS(SVG_NS, 'line');
                    line.setAttribute('x1', startPoint.x); line.setAttribute('y1', startPoint.y);
                    line.setAttribute('x2', endPoint.x); line.setAttribute('y2', endPoint.y);
                    line.setAttribute('class', 'zodiac-divider');
                    svg.appendChild(line);

                    // Place glyph in the middle of the sign
                    const midAngle = start + (end - start) / 2;
                    const textCoords = getCoords(glyphRadius, midAngle);
                    const text = document.createElementNS(SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'zodiac-glyph');
                    text.textContent = ZODIAC_GLYPHS[name];
                    svg.appendChild(text);
                });
            }

            // Draw aspect lines first so they are in the background
            const aspectGroup = document.createElementNS(SVG_NS, 'g');
            if (data.aspects) {
                data.aspects.forEach(aspect => {
                    if (aspect.p1_degrees === null || aspect.p2_degrees === null) return;
                    const startPoint = getCoords(innerRadius, aspect.p1_degrees);
                    const endPoint = getCoords(innerRadius, aspect.p2_degrees);
                    const line = document.createElementNS(SVG_NS, 'line');
                    line.setAttribute('x1', startPoint.x); line.setAttribute('y1', startPoint.y);
                    line.setAttribute('x2', endPoint.x); line.setAttribute('y2', endPoint.y);
                    const aspectClass = aspect.type.toLowerCase().replace(' ', '-');
                    line.setAttribute('class', `aspect-line aspect-${aspectClass}`);
                    aspectGroup.appendChild(line);
                });
            }
            svg.appendChild(aspectGroup);

            // Draw house cusps and numbers
            if (data.house_cusps && data.house_cusps.length === 12) {
                data.house_cusps.forEach((cuspDegrees, i) => {
                    const startPoint = getCoords(innerRadius, cuspDegrees);
                    const endPoint = getCoords(houseRingRadius, cuspDegrees);
                    const line = document.createElementNS(SVG_NS, 'line');
                    line.setAttribute('x1', startPoint.x); line.setAttribute('y1', startPoint.y);
                    line.setAttribute('x2', endPoint.x); line.setAttribute('y2', endPoint.y);
                    line.setAttribute('class', (i === 0 || i === 9) ? 'house-cusp major' : 'house-cusp');
                    svg.appendChild(line);
                });
                for (let i = 0; i < 12; i++) {
                    const startAngle = data.house_cusps[i];
                    const endAngle = data.house_cusps[(i + 1) % 12];
                    let midAngle = (startAngle + endAngle) / 2;
                    if (endAngle < startAngle) midAngle = (startAngle + endAngle + 360) / 2;
                    const textCoords = getCoords(innerRadius + 35, midAngle);
                    const text = document.createElementNS(SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'house-number');
                    text.textContent = i + 1;
                    svg.appendChild(text);
                }
            }
            
            // Place the Planets
            if (data.major_positions) {
                const sortedPlanets = [...data.major_positions].sort((a, b) => a.degrees - b.degrees);
                sortedPlanets.forEach((planet, i) => {
                    if (planet.degrees === null || !PLANET_GLYPHS[planet.name]) return;
                    let currentRadius = planetRingRadius + (i % 3 - 1) * 25;
                    const textCoords = getCoords(currentRadius, planet.degrees);
                    const text = document.createElementNS(SVG_NS, 'text');
                    text.setAttribute('x', textCoords.x); text.setAttribute('y', textCoords.y);
                    text.setAttribute('class', 'planet-glyph');
                    text.textContent = PLANET_GLYPHS[planet.name];
                    svg.appendChild(text);
                    if (planet.retrograde) {
                        const rxCoords = getCoords(currentRadius, planet.degrees + 6);
                        const rxText = document.createElementNS(SVG_NS, 'text');
                        rxText.setAttribute('x', rxCoords.x); rxText.setAttribute('y', rxCoords.y);
                        rxText.setAttribute('class', 'planet-retrograde');
                        rxText.textContent = '℞';
                        svg.appendChild(rxText);
                    }
                });
            }
        }
    </script>
</body>
</html>
