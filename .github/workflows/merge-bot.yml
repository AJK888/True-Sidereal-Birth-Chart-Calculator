name: Merge Bot

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: github.event.pull_request != null
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Safety checks
        run: |
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Actor: ${{ github.actor }}"
          echo "Action: ${{ github.event.action }}"
          echo "Sender: ${{ github.event.sender.login }}"
          echo "Head repo: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "Base repo: ${{ github.repository }}"

          # Block forks (critical)
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "‚ùå Refusing to merge: PR is from a fork."
            exit 1
          fi

          # Only enforce "AJK888 applied label" check when action is "labeled"
          # Allow re-runs on synchronize/reopened if label is already present
          if [ "${{ github.event.action }}" = "labeled" ]; then
            if [ "${{ github.event.sender.login }}" != "AJK888" ]; then
              echo "‚ùå Refusing to merge: automerge label not applied by AJK888."
              exit 1
            fi
            echo "‚úÖ Label applied by AJK888"
          else
            echo "‚úÖ Re-running on ${{ github.event.action }} event (label check will happen later)"
          fi

          echo "‚úÖ Safety checks passed"

      - name: Check if automerge label exists
        id: check-label
        run: |
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' || echo "")
          if echo "$LABELS" | grep -q "automerge"; then
            echo "has_automerge=true" >> $GITHUB_OUTPUT
            echo "‚úÖ automerge label found"
          else
            echo "has_automerge=false" >> $GITHUB_OUTPUT
            echo "‚ùå automerge label not found"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR is mergeable
        id: check-mergeable
        if: steps.check-label.outputs.has_automerge == 'true'
        run: |
          PR_STATE=$(gh pr view ${{ github.event.pull_request.number }} --json mergeable,mergeStateStatus --jq '{mergeable: .mergeable, state: .mergeStateStatus}' || echo '{"mergeable":false,"state":"unknown"}')
          MERGEABLE=$(echo "$PR_STATE" | jq -r '.mergeable // false')
          STATE=$(echo "$PR_STATE" | jq -r '.state // "unknown"')

          # Handle both boolean true and string "MERGEABLE"
          if ([ "$MERGEABLE" = "true" ] || [ "$MERGEABLE" = "MERGEABLE" ]) && [ "$STATE" != "BLOCKED" ]; then
            echo "can_merge=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is mergeable (mergeable: $MERGEABLE, state: $STATE)"
          else
            echo "can_merge=false" >> $GITHUB_OUTPUT
            echo "‚è≥ PR is not mergeable (mergeable: $MERGEABLE, state: $STATE)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR
        if: steps.check-label.outputs.has_automerge == 'true' && steps.check-mergeable.outputs.can_merge == 'true'
        run: |
          echo "üöÄ Merging PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log merge attempt
        if: always()
        run: |
          if [ "${{ steps.check-label.outputs.has_automerge }}" = "true" ]; then
            if [ "${{ steps.check-mergeable.outputs.can_merge }}" = "true" ]; then
              echo "‚úÖ Merge completed successfully"
            else
              echo "‚è≥ PR has automerge label but is not yet mergeable"
            fi
          else
            echo "‚ÑπÔ∏è  PR does not have automerge label"
          fi
